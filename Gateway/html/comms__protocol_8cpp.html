<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>sensor_network: /sensor_network/gateway_serial/comms_protocol.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">sensor_network
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">/sensor_network/gateway_serial/comms_protocol.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Communication Protocol library - set of functions and data structures used to build a network using the LoRa modulation radios.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="comms__protocol_8h_source.html">comms_protocol.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a06975cd9bbd411aa976a52d26172d910"><td class="memItemLeft" align="right" valign="top">cppQueue&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#a06975cd9bbd411aa976a52d26172d910">relay_q</a> (sizeof(char) *<a class="el" href="comms__protocol_8h.html#a3ea85ebbdc9c6fece31540aeff4887da">MAX_JSON_PAYLOAD_SIZE</a>, <a class="el" href="comms__protocol_8h.html#ae2132d5b9e92cbf586fc556351235b75">MAX_R_QUEUE_SIZE</a>, <a class="el" href="comms__protocol_8h.html#aafd24a334088de3d7fef309914d49101">IMPLEMENTATION</a>)</td></tr>
<tr class="separator:a06975cd9bbd411aa976a52d26172d910"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5cff2e13cf4105bf39e0843561f55637"><td class="memItemLeft" align="right" valign="top">cppQueue&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#a5cff2e13cf4105bf39e0843561f55637">msg_q</a> (sizeof(<a class="el" href="comms__protocol_8h.html#ad014e4a11d57536042f2c321a8bbbb05">Msg</a>), <a class="el" href="comms__protocol_8h.html#a623ec78b7909090dbedac4af1d52abb4">MAX_QUEUE_SIZE</a>, <a class="el" href="comms__protocol_8h.html#aafd24a334088de3d7fef309914d49101">IMPLEMENTATION</a>)</td></tr>
<tr class="separator:a5cff2e13cf4105bf39e0843561f55637"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af107f16dd1552bb658c1936141d9ae7a"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#af107f16dd1552bb658c1936141d9ae7a">LoRa_rxMode</a> ()</td></tr>
<tr class="memdesc:af107f16dd1552bb658c1936141d9ae7a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets the LoRa radio to receive mode.  <a href="comms__protocol_8cpp.html#af107f16dd1552bb658c1936141d9ae7a">More...</a><br /></td></tr>
<tr class="separator:af107f16dd1552bb658c1936141d9ae7a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af2b412b05e4e8c055d44f3eaab81a3ec"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#af2b412b05e4e8c055d44f3eaab81a3ec">LoRa_txMode</a> ()</td></tr>
<tr class="memdesc:af2b412b05e4e8c055d44f3eaab81a3ec"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets the LoRa radio to transmit mode.  <a href="comms__protocol_8cpp.html#af2b412b05e4e8c055d44f3eaab81a3ec">More...</a><br /></td></tr>
<tr class="separator:af2b412b05e4e8c055d44f3eaab81a3ec"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a267d79c14db504f1c516440fc4e5393b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#a267d79c14db504f1c516440fc4e5393b">LoRa_sendMessage</a> (byte *message, byte nodeID)</td></tr>
<tr class="memdesc:a267d79c14db504f1c516440fc4e5393b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets the radio to transmit mode, sends a message string using the LoRa radio and sets the radio back to receive mode.  <a href="comms__protocol_8cpp.html#a267d79c14db504f1c516440fc4e5393b">More...</a><br /></td></tr>
<tr class="separator:a267d79c14db504f1c516440fc4e5393b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a43b76b5cd582329628593a29c236dfd8"><td class="memItemLeft" align="right" valign="top">byte *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#a43b76b5cd582329628593a29c236dfd8">encrypt</a> (char msg[<a class="el" href="comms__protocol_8h.html#a6303f7392a2d06be5a121c54278d561b">MAX_PAYLOAD_SIZE</a>])</td></tr>
<tr class="memdesc:a43b76b5cd582329628593a29c236dfd8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Encrypts a message (character array) using the AES256 algorythm with the corresponding node key The encryption is made by encrypting blocks of 16 bytes and joining them together.  <a href="comms__protocol_8cpp.html#a43b76b5cd582329628593a29c236dfd8">More...</a><br /></td></tr>
<tr class="separator:a43b76b5cd582329628593a29c236dfd8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0c9867df000c907e29c02fbd4e1349c8"><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#a0c9867df000c907e29c02fbd4e1349c8">decryptMsg</a> (char msg[<a class="el" href="comms__protocol_8h.html#a6303f7392a2d06be5a121c54278d561b">MAX_PAYLOAD_SIZE</a>+1])</td></tr>
<tr class="memdesc:a0c9867df000c907e29c02fbd4e1349c8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Decrypts a message string using the AES256 algorythm with the corresponding node key.  <a href="comms__protocol_8cpp.html#a0c9867df000c907e29c02fbd4e1349c8">More...</a><br /></td></tr>
<tr class="separator:a0c9867df000c907e29c02fbd4e1349c8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac8271805926e924f56b4d0f889c8bec1"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#ac8271805926e924f56b4d0f889c8bec1">mymin</a> (int a, int b)</td></tr>
<tr class="memdesc:ac8271805926e924f56b4d0f889c8bec1"><td class="mdescLeft">&#160;</td><td class="mdescRight">returns the minimum value between two integers  <a href="comms__protocol_8cpp.html#ac8271805926e924f56b4d0f889c8bec1">More...</a><br /></td></tr>
<tr class="separator:ac8271805926e924f56b4d0f889c8bec1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abd22add5125783eb2eb84d3aeffe7f2f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#abd22add5125783eb2eb84d3aeffe7f2f">sendAck</a> (byte msgID, byte nodeID)</td></tr>
<tr class="memdesc:abd22add5125783eb2eb84d3aeffe7f2f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Send an acknowledge message confirming the reception of an uplink transmission.  <a href="comms__protocol_8cpp.html#abd22add5125783eb2eb84d3aeffe7f2f">More...</a><br /></td></tr>
<tr class="separator:abd22add5125783eb2eb84d3aeffe7f2f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8a00db8781effc6b141f2c4fd8646254"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#a8a00db8781effc6b141f2c4fd8646254">sendStatusRequest</a> (byte nodeID)</td></tr>
<tr class="memdesc:a8a00db8781effc6b141f2c4fd8646254"><td class="mdescLeft">&#160;</td><td class="mdescRight">Send a status request message asking for a specific node to respond with a status update.  <a href="comms__protocol_8cpp.html#a8a00db8781effc6b141f2c4fd8646254">More...</a><br /></td></tr>
<tr class="separator:a8a00db8781effc6b141f2c4fd8646254"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afae50b92afd675e09293f2930472cb58"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#afae50b92afd675e09293f2930472cb58">sendActuatorControl</a> (byte nodeID, byte actID, byte actVal)</td></tr>
<tr class="memdesc:afae50b92afd675e09293f2930472cb58"><td class="mdescLeft">&#160;</td><td class="mdescRight">Send a control message to set a value for a node's actuator.  <a href="comms__protocol_8cpp.html#afae50b92afd675e09293f2930472cb58">More...</a><br /></td></tr>
<tr class="separator:afae50b92afd675e09293f2930472cb58"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a091b9218e6ed5b060bc3d1104dde7109"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#a091b9218e6ed5b060bc3d1104dde7109">getMsgFromQueueAndSend</a> (unsigned long currentMillis)</td></tr>
<tr class="memdesc:a091b9218e6ed5b060bc3d1104dde7109"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get a message from the send queue and send it. Implements retransmission in case an acknowledge message is not received. Aware of a failed transmission.  <a href="comms__protocol_8cpp.html#a091b9218e6ed5b060bc3d1104dde7109">More...</a><br /></td></tr>
<tr class="separator:a091b9218e6ed5b060bc3d1104dde7109"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af05ee2950c64bf21cb7aa13a8280163f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#af05ee2950c64bf21cb7aa13a8280163f">relayMsgFromQueueToServer</a> (unsigned long currentMillis)</td></tr>
<tr class="memdesc:af05ee2950c64bf21cb7aa13a8280163f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get a message from the relay queue and send it to the server via serial communication.  <a href="comms__protocol_8cpp.html#af05ee2950c64bf21cb7aa13a8280163f">More...</a><br /></td></tr>
<tr class="separator:af05ee2950c64bf21cb7aa13a8280163f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afaa2caa37a55c9125471b5b6f1f6324b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#afaa2caa37a55c9125471b5b6f1f6324b">constructJsonAndAddToQueue</a> (<a class="el" href="comms__protocol_8h.html#a9e00f468ca1d333265668dbd3c712260">Payload</a> p)</td></tr>
<tr class="memdesc:afaa2caa37a55c9125471b5b6f1f6324b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Builds a json string containg the message information and adds the string to the relay queue.  <a href="comms__protocol_8cpp.html#afaa2caa37a55c9125471b5b6f1f6324b">More...</a><br /></td></tr>
<tr class="separator:afaa2caa37a55c9125471b5b6f1f6324b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a15c330bc3cd75ecf3800db120a1a22d3"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#a15c330bc3cd75ecf3800db120a1a22d3">relayDownlinkMsg</a> (char *dlMsg)</td></tr>
<tr class="memdesc:a15c330bc3cd75ecf3800db120a1a22d3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Relays the downlink messages received from the server to the corresponding node. Formats the message into a compact form.  <a href="comms__protocol_8cpp.html#a15c330bc3cd75ecf3800db120a1a22d3">More...</a><br /></td></tr>
<tr class="separator:a15c330bc3cd75ecf3800db120a1a22d3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a54817002e33761dc61558b1138749dfb"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#a54817002e33761dc61558b1138749dfb">onReceive</a> (int packetSize)</td></tr>
<tr class="memdesc:a54817002e33761dc61558b1138749dfb"><td class="mdescLeft">&#160;</td><td class="mdescRight">Called every time a new message is received. Filters unwanted messages, decrypts the payload, gets the relevant fields from the payload and sends back an acknowledge message if necessary. Finally, calls constructJsonAndAddToQueue to build a json message destined for the server.  <a href="comms__protocol_8cpp.html#a54817002e33761dc61558b1138749dfb">More...</a><br /></td></tr>
<tr class="separator:a54817002e33761dc61558b1138749dfb"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a0a46edecb372aedab666bb0b845ba6b8"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#a0a46edecb372aedab666bb0b845ba6b8">currMsg</a> = -1</td></tr>
<tr class="separator:a0a46edecb372aedab666bb0b845ba6b8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad43c3812e6d13e0518d9f8b8f463ffcf"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> = 0</td></tr>
<tr class="separator:ad43c3812e6d13e0518d9f8b8f463ffcf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0dba2457ef8608730abaa9e430b5d11e"><td class="memItemLeft" align="right" valign="top">unsigned long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#a0dba2457ef8608730abaa9e430b5d11e">prevMilR</a></td></tr>
<tr class="separator:a0dba2457ef8608730abaa9e430b5d11e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afad07369259cd493d556473fa3ba8433"><td class="memItemLeft" align="right" valign="top">unsigned long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#afad07369259cd493d556473fa3ba8433">prevMil</a></td></tr>
<tr class="separator:afad07369259cd493d556473fa3ba8433"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acba68ade9b1d4ddf6d4289092bd9f21d"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#acba68ade9b1d4ddf6d4289092bd9f21d">msgCount</a> = 0</td></tr>
<tr class="separator:acba68ade9b1d4ddf6d4289092bd9f21d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a38ebab104a77fc87f092da8bc068a58f"><td class="memItemLeft" align="right" valign="top">aes256_context&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="comms__protocol_8cpp.html#a38ebab104a77fc87f092da8bc068a58f">ctxt</a></td></tr>
<tr class="separator:a38ebab104a77fc87f092da8bc068a58f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Communication Protocol library - set of functions and data structures used to build a network using the LoRa modulation radios. </p>
<dl class="section author"><dt>Author</dt><dd>Francisco Santos (<a href="#" onclick="location.href='mai'+'lto:'+'fra'+'nc'+'isc'+'o.'+'vel'+'ez'+'@te'+'cn'+'ico'+'.u'+'lis'+'bo'+'a.p'+'t'; return false;">franc<span style="display: none;">.nosp@m.</span>isco<span style="display: none;">.nosp@m.</span>.vele<span style="display: none;">.nosp@m.</span>z@te<span style="display: none;">.nosp@m.</span>cnico<span style="display: none;">.nosp@m.</span>.uli<span style="display: none;">.nosp@m.</span>sboa.<span style="display: none;">.nosp@m.</span>pt</a>) </dd></dl>
<dl class="section version"><dt>Version</dt><dd>1.0 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2022-08-10</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright (c) 2022 </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="afaa2caa37a55c9125471b5b6f1f6324b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afaa2caa37a55c9125471b5b6f1f6324b">&#9670;&nbsp;</a></span>constructJsonAndAddToQueue()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void constructJsonAndAddToQueue </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="comms__protocol_8h.html#a9e00f468ca1d333265668dbd3c712260">Payload</a>&#160;</td>
          <td class="paramname"><em>p</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Builds a json string containg the message information and adds the string to the relay queue. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">p</td><td>payload structure containing the message information along with RSSI, SNR and battery voltage </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>void </dd></dl>

</div>
</div>
<a id="a0c9867df000c907e29c02fbd4e1349c8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0c9867df000c907e29c02fbd4e1349c8">&#9670;&nbsp;</a></span>decryptMsg()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* decryptMsg </td>
          <td>(</td>
          <td class="paramtype">char&#160;</td>
          <td class="paramname"><em>msg</em>[MAX_PAYLOAD_SIZE+1]</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Decrypts a message string using the AES256 algorythm with the corresponding node key. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">msg</td><td>message string to be decrypted </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>char* an array of characters containing the decrypted message </dd></dl>

</div>
</div>
<a id="a43b76b5cd582329628593a29c236dfd8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a43b76b5cd582329628593a29c236dfd8">&#9670;&nbsp;</a></span>encrypt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">byte* encrypt </td>
          <td>(</td>
          <td class="paramtype">char&#160;</td>
          <td class="paramname"><em>msg</em>[MAX_PAYLOAD_SIZE]</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Encrypts a message (character array) using the AES256 algorythm with the corresponding node key The encryption is made by encrypting blocks of 16 bytes and joining them together. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">msg</td><td>message array to be decrypted </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>byte* a byte array containing the encrypted message </dd></dl>

</div>
</div>
<a id="a091b9218e6ed5b060bc3d1104dde7109"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a091b9218e6ed5b060bc3d1104dde7109">&#9670;&nbsp;</a></span>getMsgFromQueueAndSend()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void getMsgFromQueueAndSend </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>currentMillis</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get a message from the send queue and send it. Implements retransmission in case an acknowledge message is not received. Aware of a failed transmission. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">currentMillis</td><td>current time in millisenconds since boot </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>void </dd></dl>

</div>
</div>
<a id="af107f16dd1552bb658c1936141d9ae7a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af107f16dd1552bb658c1936141d9ae7a">&#9670;&nbsp;</a></span>LoRa_rxMode()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void LoRa_rxMode </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sets the LoRa radio to receive mode. </p>
<dl class="section return"><dt>Returns</dt><dd>void </dd></dl>

</div>
</div>
<a id="a267d79c14db504f1c516440fc4e5393b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a267d79c14db504f1c516440fc4e5393b">&#9670;&nbsp;</a></span>LoRa_sendMessage()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void LoRa_sendMessage </td>
          <td>(</td>
          <td class="paramtype">byte *&#160;</td>
          <td class="paramname"><em>message</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">byte&#160;</td>
          <td class="paramname"><em>nodeID</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sets the radio to transmit mode, sends a message string using the LoRa radio and sets the radio back to receive mode. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">message</td><td>message to send </td></tr>
    <tr><td class="paramname">nodeID</td><td>ID of the destination node </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>void </dd></dl>

</div>
</div>
<a id="af2b412b05e4e8c055d44f3eaab81a3ec"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af2b412b05e4e8c055d44f3eaab81a3ec">&#9670;&nbsp;</a></span>LoRa_txMode()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void LoRa_txMode </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sets the LoRa radio to transmit mode. </p>
<dl class="section return"><dt>Returns</dt><dd>void </dd></dl>

</div>
</div>
<a id="a5cff2e13cf4105bf39e0843561f55637"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5cff2e13cf4105bf39e0843561f55637">&#9670;&nbsp;</a></span>msg_q()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cppQueue msg_q </td>
          <td>(</td>
          <td class="paramtype">sizeof(<a class="el" href="comms__protocol_8h.html#ad014e4a11d57536042f2c321a8bbbb05">Msg</a>)&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="comms__protocol_8h.html#a623ec78b7909090dbedac4af1d52abb4">MAX_QUEUE_SIZE</a>&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="comms__protocol_8h.html#aafd24a334088de3d7fef309914d49101">IMPLEMENTATION</a>&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ac8271805926e924f56b4d0f889c8bec1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac8271805926e924f56b4d0f889c8bec1">&#9670;&nbsp;</a></span>mymin()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int mymin </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>b</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>returns the minimum value between two integers </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">a</td><td>first integer to compare </td></tr>
    <tr><td class="paramname">b</td><td>second integer to compare </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>int the smaller between a and b </dd></dl>

</div>
</div>
<a id="a54817002e33761dc61558b1138749dfb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a54817002e33761dc61558b1138749dfb">&#9670;&nbsp;</a></span>onReceive()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void onReceive </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>packetSize</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Called every time a new message is received. Filters unwanted messages, decrypts the payload, gets the relevant fields from the payload and sends back an acknowledge message if necessary. Finally, calls constructJsonAndAddToQueue to build a json message destined for the server. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">packetSize</td><td>size of the incoming message in bytes </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a06975cd9bbd411aa976a52d26172d910"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a06975cd9bbd411aa976a52d26172d910">&#9670;&nbsp;</a></span>relay_q()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cppQueue relay_q </td>
          <td>(</td>
          <td class="paramtype">sizeof(char) *&#160;</td>
          <td class="paramname"><em>MAX_JSON_PAYLOAD_SIZE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="comms__protocol_8h.html#ae2132d5b9e92cbf586fc556351235b75">MAX_R_QUEUE_SIZE</a>&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="comms__protocol_8h.html#aafd24a334088de3d7fef309914d49101">IMPLEMENTATION</a>&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a15c330bc3cd75ecf3800db120a1a22d3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a15c330bc3cd75ecf3800db120a1a22d3">&#9670;&nbsp;</a></span>relayDownlinkMsg()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void relayDownlinkMsg </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>dlMsg</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Relays the downlink messages received from the server to the corresponding node. Formats the message into a compact form. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dlMsg</td><td>character array containing the downlink message to be relayed </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="af05ee2950c64bf21cb7aa13a8280163f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af05ee2950c64bf21cb7aa13a8280163f">&#9670;&nbsp;</a></span>relayMsgFromQueueToServer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void relayMsgFromQueueToServer </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>currentMillis</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get a message from the relay queue and send it to the server via serial communication. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">currentMillis</td><td>current time in millisenconds since boot </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>void </dd></dl>

</div>
</div>
<a id="abd22add5125783eb2eb84d3aeffe7f2f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abd22add5125783eb2eb84d3aeffe7f2f">&#9670;&nbsp;</a></span>sendAck()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void sendAck </td>
          <td>(</td>
          <td class="paramtype">byte&#160;</td>
          <td class="paramname"><em>msgID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">byte&#160;</td>
          <td class="paramname"><em>nodeID</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Send an acknowledge message confirming the reception of an uplink transmission. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">msgID</td><td>ID of the message being acknowledged </td></tr>
    <tr><td class="paramname">nodeID</td><td>ID of the destination node </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>void </dd></dl>

</div>
</div>
<a id="afae50b92afd675e09293f2930472cb58"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afae50b92afd675e09293f2930472cb58">&#9670;&nbsp;</a></span>sendActuatorControl()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void sendActuatorControl </td>
          <td>(</td>
          <td class="paramtype">byte&#160;</td>
          <td class="paramname"><em>nodeID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">byte&#160;</td>
          <td class="paramname"><em>actID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">byte&#160;</td>
          <td class="paramname"><em>actVal</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Send a control message to set a value for a node's actuator. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">nodeID</td><td>ID of the destination node </td></tr>
    <tr><td class="paramname">actID</td><td>ID of the actuator to control </td></tr>
    <tr><td class="paramname">actVal</td><td>Value to set the actuator to </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>void </dd></dl>

</div>
</div>
<a id="a8a00db8781effc6b141f2c4fd8646254"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8a00db8781effc6b141f2c4fd8646254">&#9670;&nbsp;</a></span>sendStatusRequest()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void sendStatusRequest </td>
          <td>(</td>
          <td class="paramtype">byte&#160;</td>
          <td class="paramname"><em>nodeID</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Send a status request message asking for a specific node to respond with a status update. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">nodeID</td><td>ID of the destination node </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>void </dd></dl>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="ad43c3812e6d13e0518d9f8b8f463ffcf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad43c3812e6d13e0518d9f8b8f463ffcf">&#9670;&nbsp;</a></span>count</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int count = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a38ebab104a77fc87f092da8bc068a58f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a38ebab104a77fc87f092da8bc068a58f">&#9670;&nbsp;</a></span>ctxt</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">aes256_context ctxt</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a0a46edecb372aedab666bb0b845ba6b8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0a46edecb372aedab666bb0b845ba6b8">&#9670;&nbsp;</a></span>currMsg</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int currMsg = -1</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="acba68ade9b1d4ddf6d4289092bd9f21d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acba68ade9b1d4ddf6d4289092bd9f21d">&#9670;&nbsp;</a></span>msgCount</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int msgCount = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="afad07369259cd493d556473fa3ba8433"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afad07369259cd493d556473fa3ba8433">&#9670;&nbsp;</a></span>prevMil</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned long prevMil</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a0dba2457ef8608730abaa9e430b5d11e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0dba2457ef8608730abaa9e430b5d11e">&#9670;&nbsp;</a></span>prevMilR</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned long prevMilR</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
